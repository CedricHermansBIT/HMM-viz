<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hmmer-Viz</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .bar-above-threshold {
            fill: firebrick;
        }

        .bar-below-threshold {
            fill: steelblue;
        }

        #chart {
            display: flex;
            flex-wrap: wrap;
        }

        .modal-header {
            cursor: move;
        }

        .modal-body {
            max-height: calc(100vh - 210px);
            overflow-y: auto;
        }

        .modal-dialog {
            max-width: 90%;
        }

        svg {
            border: 1px solid #000;
            overflow: visible;
        }

        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <input type="file" name="hmm_out" id="hmm">
    <a id="filter"></a>
    <h2 id="information"></h2>
    <div id="chart"></div>
    <!-- Bootstrap Modal -->
    <div class="modal fade" id="hitsModal" tabindex="-1" role="dialog" aria-labelledby="hitsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hitsModalLabel">Hits</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="hits"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <script>
        var chart_width = window.innerWidth / 2;
        var chart_height = (window.innerHeight - 100) / 2; // 100px for the file input


        // on file upload
        document.getElementById('hmm').addEventListener('change', function (e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                //console.log(e.target.result);
                // get the different domains from the file with number of hits for each domain and split them also based on inclusion threshold line
                // domain is denoted by line starting with Accession: 
                // actual hits start after "    ------- ------ -----    ------- ------ -----   ---- --  --------   -----------"
                // inclusion threshold line starts with "  ------ inclusion threshold ------"
                var data = e.target.result.split('\n');
                var domains = [];
                var q_file_to_sequence = {};
                var in_hits = false;
                var in_inclusion_threshold = false;
                var current_index = 0;
                var current_genome = "";
                var query_name = "";
                for (var i = 0; i < data.length; i++) {
                    if (data[i].startsWith('# target sequence database:')) {
                        current_genome = data[i].split('# target sequence database:')[1].trim();
                        continue;
                    }
                    if (data[i].startsWith('Query:')) {
                        query_name = data[i].split('Query:')[1].trim().split(/\s+/)[0];
                        continue;
                    }
                    if (data[i].startsWith('Accession:')) {
                        var accession = data[i].split('Accession:')[1].trim();
                        // if accession is not yet in the domains array (can be out of order), add it
                        if (!domains.find(d => d.accession === accession)) {
                            var domain = {
                                accession: accession,
                                query_name: query_name,
                                hits: [],
                                above_inclusion_threshold: []
                            };
                            domains.push(domain);
                        }
                        // get the index of the current domain
                        current_index = domains.findIndex(d => d.accession === accession);
                        in_hits = true;
                        in_inclusion_threshold = false;
                    } else if (data[i].startsWith('  ------ inclusion threshold ------')) {
                        if (in_hits) {
                            in_inclusion_threshold = true;
                            in_hits = false;
                        }
                    } else if (in_hits) {
                        if (data[i] == "") {
                            in_hits = false;
                            in_inclusion_threshold = false;
                        }
                        if (!data[i].startsWith('  ')) {
                            continue;
                        }
                        // E-value  score  bias    E-value  score  bias    exp  N  Sequence   Description
                        var hit = data[i].trim().split(/\s+/);
                        if (!hit[0].match(/^\d/)) {
                            continue;
                        }
                        if (hit.length > 1) {
                            if (!q_file_to_sequence[current_genome]) {
                                q_file_to_sequence[current_genome] = [];
                            }
                            if (!q_file_to_sequence[current_genome].includes(hit[8])) {
                                q_file_to_sequence[current_genome].push(hit[8]);
                            }

                            domains[current_index].hits.push({
                                current_genome: current_genome,
                                e_value: Number(hit[0]),
                                score: hit[1],
                                bias: hit[2],
                                e_value_best: hit[3],
                                score_best: hit[4],
                                bias_best: hit[5],
                                exp: hit[6],
                                N: hit[7],
                                sequence: hit[8],
                                description: hit[9]
                            });
                        }
                    } else if (in_inclusion_threshold) {
                        if (data[i] == "") {
                            in_inclusion_threshold = false;
                        }
                        var hit = data[i].trim().split(/\s+/);
                        // hit should start with a number
                        if (!hit[0].match(/^\d/)) {
                            continue;
                        }
                        if (hit.length > 1) {
                            domains[current_index].above_inclusion_threshold.push({
                                current_genome: current_genome,
                                e_value: Number(hit[0]),
                                score: hit[1],
                                bias: hit[2],
                                e_value_best: hit[3],
                                score_best: hit[4],
                                bias_best: hit[5],
                                exp: hit[6],
                                N: hit[7],
                                sequence: hit[8],
                                description: hit[9]
                            });
                        }
                    }
                }
                // fill in information h1 with Number of domains and Number of genomes
                var number_of_domains = domains.length;
                var all_genomes = [];
                for (var i = 0; i < domains.length; i++) {
                    for (var j = 0; j < domains[i].hits.length; j++) {
                        if (!all_genomes.includes(domains[i].hits[j].current_genome)) {
                            all_genomes.push(domains[i].hits[j].current_genome);
                        }
                    }
                    for (var j = 0; j < domains[i].above_inclusion_threshold.length; j++) {
                        if (!all_genomes.includes(domains[i].above_inclusion_threshold[j].current_genome)) {
                            all_genomes.push(domains[i].above_inclusion_threshold[j].current_genome);
                        }
                    }
                }
                var number_of_genomes = all_genomes.length;
                document.getElementById("information").innerHTML = "Number of domains: " + number_of_domains + " | Number of genomes: " + number_of_genomes;

                addFilter(domains);
                visualizeDomains(domains);
                visualizeEValueDistribution(domains);
                visualizeGenomes(domains);
                visualizeGenomeDistributionBoxplots(domains);

                console.log(q_file_to_sequence);
                // combine all sequences
                var all_sequences = [];
                for (var genome in q_file_to_sequence) {
                    for (sequence of q_file_to_sequence[genome]) {
                        console.log(genome, sequence);
                    }
                }
            };
            reader.readAsText(file);
        });

        function addFilter(domains) {
            var all_genomes = [];
            for (var i = 0; i < domains.length; i++) {
                for (var j = 0; j < domains[i].hits.length; j++) {
                    if (!all_genomes.includes(domains[i].hits[j].current_genome)) {
                        all_genomes.push(domains[i].hits[j].current_genome);
                    }
                }
                for (var j = 0; j < domains[i].above_inclusion_threshold.length; j++) {
                    if (!all_genomes.includes(domains[i].above_inclusion_threshold[j].current_genome)) {
                        all_genomes.push(domains[i].above_inclusion_threshold[j].current_genome);
                    }
                }
            }

            // add a dropdown to select the genome
            var select = document.createElement("select");
            select.id = "genome";
            select.name = "genome";
            var option = document.createElement("option");
            option.value = "all";
            option.text = "All Genomes";
            select.appendChild(option);
            for (var i = 0; i < all_genomes.length; i++) {
                var option = document.createElement("option");
                option.value = all_genomes[i];
                option.text = all_genomes[i];
                select.appendChild(option);
            }
            // empty the filter div and add the select element
            document.getElementById("filter").innerHTML = "";
            document.getElementById("filter").appendChild(select);

            // add an event listener to the select element
            select.addEventListener('change', function (e) {
                var selected_genome = e.target.value;
                if (selected_genome === "all") {
                    visualizeDomains(domains);
                    visualizeEValueDistribution(domains);
                    visualizeGenomes(domains);
                    visualizeGenomeDistributionBoxplots(domains);
                    return;
                }
                var filtered_domains = [];
                for (var i = 0; i < domains.length; i++) {
                    var domain = {
                        accession: domains[i].accession,
                        query_name: domains[i].query_name,
                        hits: [],
                        above_inclusion_threshold: []
                    };
                    for (var j = 0; j < domains[i].hits.length; j++) {
                        if (domains[i].hits[j].current_genome === selected_genome) {
                            domain.hits.push(domains[i].hits[j]);
                        }
                    }
                    for (var j = 0; j < domains[i].above_inclusion_threshold.length; j++) {
                        if (domains[i].above_inclusion_threshold[j].current_genome === selected_genome) {
                            domain.above_inclusion_threshold.push(domains[i].above_inclusion_threshold[j]);
                        }
                    }
                    filtered_domains.push(domain);
                }
                visualizeDomains(filtered_domains);
                visualizeEValueDistribution(filtered_domains);
                visualizeGenomes(domains);
                visualizeGenomeDistributionBoxplots(domains);
            });
        }

        function visualizeDomains(domains) {
            // Clear previous chart
            d3.select("#chart").html("");

            // Set up dimensions
            var margin = { top: 50, right: 30, bottom: 200, left: 60 };
            var windowWidth = chart_width;
            var windowHeight = chart_height; // 100px for the file input
            var width = windowWidth - margin.left - margin.right;
            var height = windowHeight - margin.top - margin.bottom;

            // add for each domain the number of hits per genome
            for (var i = 0; i < domains.length; i++) {
                var genome_hits = [];
                for (var j = 0; j < domains[i].hits.length; j++) {
                    var genome = domains[i].hits[j].current_genome;
                    var index = genome_hits.findIndex(g => g.genome === genome);
                    if (index === -1) {
                        genome_hits.push({ genome: genome, hits: 1 });
                    } else {
                        genome_hits[index].hits++;
                    }
                }
                domains[i].genome_hits = genome_hits;
            }


            // Create SVG
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("display", "inline-block")
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // X scale
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            // Y scale
            var y = d3.scaleLinear()
                .range([height, 0]);

            // Set domains
            x.domain(domains.map(function (d) { return d.accession + " (" + d.query_name + ")"; }));
            y.domain([0, d3.max(domains, function (d) { return d.hits.length + d.above_inclusion_threshold.length; })]);

            // Draw bars above threshold
            svg.selectAll(".bar-above-threshold")
                .data(domains)
                .enter().append("rect")
                .attr("class", "bar-above-threshold")
                .attr("x", function (d) { return x(d.accession + " (" + d.query_name + ")"); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d.hits.length + d.above_inclusion_threshold.length); })
                .attr("height", function (d) { return height - y(d.above_inclusion_threshold.length); })
                .attr("cursor", "help")
                // on mouseover show the hits
                .on("click", function (event) {
                    var d = d3.select(this).datum();
                    var hits = d.above_inclusion_threshold;
                    var table = "<table class='table'><thead><tr><th>Genome</th><th>E-Value</th><th>Score</th><th>Bias</th><th>E-Value Best</th><th>Score Best</th><th>Bias Best</th><th>Exp</th><th>N</th><th>Sequence</th><th>Description</th></tr></thead><tbody>";
                    for (var i = 0; i < hits.length; i++) {
                        table += "<tr><td>" + hits[i].current_genome + "</td><td>" + hits[i].e_value + "</td><td>" + hits[i].score + "</td><td>" + hits[i].bias + "</td><td>" + hits[i].e_value_best + "</td><td>" + hits[i].score_best + "</td><td>" + hits[i].bias_best + "</td><td>" + hits[i].exp + "</td><td>" + hits[i].N + "</td><td>" + hits[i].sequence + "</td><td>" + hits[i].description + "</td></tr>";
                    }
                    table += "</tbody></table>";
                    $("#hits").html(table);
                    $("#hitsModal").modal('show');
                });

            // Draw bars below threshold
            svg.selectAll(".bar-below-threshold")
                .data(domains)
                .enter().append("rect")
                .attr("class", "bar-below-threshold")
                .attr("x", function (d) { return x(d.accession + " (" + d.query_name + ")"); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d.hits.length); })
                .attr("height", function (d) { return height - y(d.hits.length); })
                .attr("cursor", "help")
                // on mouseover show the hits
                .on("click", function (event) {
                    var d = d3.select(this).datum();
                    var hits = d.hits;
                    var table = "<table class='table'><thead><tr><th>Genome</th><th>E-Value</th><th>Score</th><th>Bias</th><th>E-Value Best</th><th>Score Best</th><th>Bias Best</th><th>Exp</th><th>N</th><th>Sequence</th><th>Description</th></tr></thead><tbody>";
                    for (var i = 0; i < hits.length; i++) {
                        table += "<tr><td>" + hits[i].current_genome + "</td><td>" + hits[i].e_value + "</td><td>" + hits[i].score + "</td><td>" + hits[i].bias + "</td><td>" + hits[i].e_value_best + "</td><td>" + hits[i].score_best + "</td><td>" + hits[i].bias_best + "</td><td>" + hits[i].exp + "</td><td>" + hits[i].N + "</td><td>" + hits[i].sequence + "</td><td>" + hits[i].description + "</td></tr>";
                    }
                    table += "</tbody></table>";
                    $("#hits").html(table);
                    $("#hitsModal").modal('show');
                });

            // Add X axis
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-65)");

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .attr("font-size", "12px");

            // Add X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Domain Accession")
                .attr("font-size", 18);

            // Add Y axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .text("Number of Hits")
                .attr("font-size", 18);

            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Hits per domain");

            // Add legend
            var legend = svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 20)
                .attr("text-anchor", "end")
                .selectAll("g")
                .data(["Above Threshold", "Below Threshold"])
                .enter().append("g")
                .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

            legend.append("rect")
                .attr("x", width - 19)
                .attr("width", 19)
                .attr("height", 19)
                .attr("fill", function (d) { return d === "Above Threshold" ? "firebrick" : "steelblue"; });

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9.5)
                .attr("dy", "0.32em")
                .text(function (d) { return d; });

        }

        function visualizeGenomes(domains) {

            // Set up dimensions
            var margin = { top: 50, right: 30, bottom: 200, left: 60 };
            var windowWidth = chart_width;
            var windowHeight = chart_height; // 100px for the file input
            var width = windowWidth - margin.left - margin.right;
            var height = windowHeight - margin.top - margin.bottom;

            // count the number of hits per genome
            var genome_hits = [];
            for (var i = 0; i < domains.length; i++) {
                for (var j = 0; j < domains[i].hits.length; j++) {
                    var genome = domains[i].hits[j].current_genome;
                    var index = genome_hits.findIndex(g => g.genome === genome);
                    if (index === -1) {
                        genome_hits.push({ genome: genome, hits: 1, above_inclusion_threshold: 0 });
                    } else {
                        genome_hits[index].hits++;
                    }
                }
                for (var j = 0; j < domains[i].above_inclusion_threshold.length; j++) {
                    var genome = domains[i].above_inclusion_threshold[j].current_genome;
                    var index = genome_hits.findIndex(g => g.genome === genome);
                    if (index === -1) {
                        genome_hits.push({ genome: genome, hits: 0, above_inclusion_threshold: 1 });
                    } else {
                        genome_hits[index].above_inclusion_threshold++;
                    }
                }
            }


            // Create SVG
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // X scale
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            // Y scale
            var y = d3.scaleLinear()
                .range([height, 0]);

            // Set domains
            x.domain(genome_hits.map(function (d) { return d.genome; }));
            y.domain([0, d3.max(genome_hits, function (d) { return d.hits + d.above_inclusion_threshold; })]);


            // Draw bars above threshold
            svg.selectAll(".bar-above-threshold")
                .data(genome_hits)
                .enter().append("rect")
                .attr("class", "bar-above-threshold")
                .attr("x", function (d) { return x(d.genome); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d.above_inclusion_threshold + d.hits); })
                .attr("height", function (d) { return height - y(d.above_inclusion_threshold); });

            // Draw bars below threshold
            svg.selectAll(".bar-below-threshold")
                .data(genome_hits)
                .enter().append("rect")
                .attr("class", "bar-below-threshold")
                .attr("x", function (d) { return x(d.genome); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d.hits); })
                .attr("height", function (d) { return height - y(d.hits); });

            // Add X axis
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-65)")
                .attr("cursor", "pointer")
                // on click, set the filter to the selected genome
                .on("click", function (event) {
                    var genome = d3.select(this).text();
                    document.getElementById("genome").value = genome;
                    var event = new Event('change');
                    document.getElementById("genome").dispatchEvent(event);
                });

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .attr("font-size", "12px");

            // Add X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Genome")
                .attr("font-size", 18);

            // Add Y axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .text("Number of Hits")
                .attr("font-size", 18);

            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Hits per genome");

            // Add legend
            var legend = svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 20)
                .attr("text-anchor", "end")
                .selectAll("g")
                .data(["Above Threshold", "Below Threshold"])
                .enter().append("g")
                .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

            legend.append("rect")
                .attr("x", width - 19)
                .attr("width", 19)
                .attr("height", 19)
                .attr("fill", function (d) { return d === "Above Threshold" ? "firebrick" : "steelblue"; });

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9.5)
                .attr("dy", "0.32em")
                .text(function (d) { return d; });
        }

        function visualizeEValueDistribution(domains) {
            // Set the dimensions and margins of the graph
            var margin = { top: 50, right: 30, bottom: 100, left: 60 };
            var windowWidth = chart_width;
            var windowHeight = chart_height; // 100px for the file input
            var width = windowWidth - margin.left - margin.right;
            var height = windowHeight - margin.top - margin.bottom;

            // Append the svg object to the body of the page
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Prepare data
            var hits = [];
            domains.forEach(domain => {
                hits = hits.concat(domain.hits.map(hit => ({ ...hit, domain: domain.accession })));
                //hits = hits.concat(domain.above_inclusion_threshold.map(hit => ({ ...hit, domain: domain.accession })));
            });

            // Build and show the Y scale
            var y = d3.scaleLinear()
                .domain([0, d3.max(hits, d => +d.e_value)])
                .range([height, 0]);
            
            var yAxis = d3.axisLeft(y)
                .tickFormat(d3.format(".1e")); // Format numbers in scientific notation

            svg.append("g").call(yAxis);
            
            // Build and show the X scale
            var x = d3.scaleBand()
                .range([0, width])
                .domain(domains.map(d => d.accession))
                .padding(0.05);
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("font-size", "12px")
                .attr("transform", "rotate(-65)");

            // Features of the histogram
            var histogram = d3.histogram()
                .domain(y.domain())
                .thresholds(y.ticks(20))
                .value(d => d.e_value);

            // Compute the binning for each group of the dataset
            var sumstat = d3.rollup(hits, v => histogram(v), d => d.domain);

            // What is the biggest number of value in a bin?
            var maxNum = 0;
            sumstat.forEach(d => {
                var allBins = d;
                var lengths = allBins.map(a => a.length);
                var longest = d3.max(lengths);
                if (longest > maxNum) maxNum = longest;
            });


            // The maximum width of a violin must be x.bandwidth
            var xNum = d3.scaleLinear()
                .range([0, x.bandwidth()])
                .domain([-maxNum, maxNum]);

            // Add the shape to this svg
            svg.selectAll("myViolin")
                .data(Array.from(sumstat))
                .enter()
                .append("g")
                .attr("transform", d => "translate(" + x(d[0]) + " ,0)")
                .append("path")
                .datum(d => d[1])
                .style("stroke", "none")
                .style("fill", "#69b3a2")
                .attr("d", d3.area()
                    .x0(d => xNum(-d.length))
                    .x1(d => xNum(d.length))
                    .y(d => y(d.x0))
                    .curve(d3.curveCatmullRom));

            // Add X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Domain Accession")
                .attr("font-size", 18);

            // Add Y axis label 
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .text("E-Value")
                .attr("font-size", 18);

            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("E-Value Distribution per Domain (below threshold)");
        }
        function visualizeGenomeDistributionBoxplots(domains) {
            // Count number of hits per genome
            var genome_hits = [];
            for (var i = 0; i < domains.length; i++) {
                for (var j = 0; j < domains[i].hits.length; j++) {
                    var genome = domains[i].hits[j].current_genome;
                    var index = genome_hits.findIndex(g => g.genome === genome);
                    if (index === -1) {
                        genome_hits.push({ genome: genome, hits: 1, above_inclusion_threshold: 0 });
                    } else {
                        genome_hits[index].hits++;
                    }
                }
                for (var j = 0; j < domains[i].above_inclusion_threshold.length; j++) {
                    var genome = domains[i].above_inclusion_threshold[j].current_genome;
                    var index = genome_hits.findIndex(g => g.genome === genome);
                    if (index === -1) {
                        genome_hits.push({ genome: genome, hits: 0, above_inclusion_threshold: 1 });
                    } else {
                        genome_hits[index].above_inclusion_threshold++;
                    }
                }
            }

            var hits = genome_hits.map(g => g.hits);
            var above_inclusion_threshold = genome_hits.map(g => g.above_inclusion_threshold);

            // Set the dimensions and margins of the graph
            var margin = { top: 50, right: 30, bottom: 100, left: 60 };
            var width = chart_width - margin.left - margin.right;
            var height = chart_height - margin.top - margin.bottom;

            // Append the svg object to the body of the page
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Compute statistics for both datasets
            var computeStats = (data) => {
                var q1 = d3.quantile(data, 0.25);
                var median = d3.quantile(data, 0.5);
                var q3 = d3.quantile(data, 0.75);
                var interQuantileRange = q3 - q1;
                var min = Math.max(0, q1 - 1.5 * interQuantileRange);
                var max = q3 + 1.5 * interQuantileRange;
                var actualMax = d3.max(data);
                var mean = d3.mean(data);
                var std = d3.deviation(data);
                return { q1, median, q3, min, max, actualMax, mean, std };
            };

            var statsHits = computeStats(hits);
            var statsAboveThreshold = computeStats(above_inclusion_threshold);

            // Set up scales
            var y = d3.scaleLinear()
                .domain([0, Math.max(d3.max(hits), d3.max(above_inclusion_threshold), statsHits.max, statsAboveThreshold.max)])
                .range([height, 0]);

            var x = d3.scaleBand()
                .range([0, width])
                .domain(['Below Threshold', 'Above Threshold'])
                .padding(0.5);

            // Add X axis
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y));

            // Function to draw a boxplot
            function drawBoxPlot(stats, xPosition, color, data) {
                var group = svg.append("g").attr("transform", "translate(" + xPosition + ",0)");
                var center = x.bandwidth() / 2;
                // Vertical line
                group.append("line")
                    .attr("x1", center)
                    .attr("x2", center)
                    .attr("y1", y(stats.min))
                    .attr("y2", y(stats.max))
                    .attr("stroke", "black");

                // Box
                group.append("rect")
                    .attr("x", center - 30)
                    .attr("y", y(stats.q3))
                    .attr("height", y(stats.q1) - y(stats.q3))
                    .attr("width", 60)
                    .attr("stroke", "black")
                    .style("fill", color)
                    .attr("cursor", "help")
                    .on("click", function (event) {
                        // show the statistics in the hits modal
                        var table = "<table class='table'><thead><tr><th>Statistic</th><th>Value</th></tr></thead><tbody>";
                        table += "<tr><td>Min</td><td>" + stats.min + "</td></tr>";
                        table += "<tr><td>Q1</td><td>" + stats.q1 + "</td></tr>";
                        table += "<tr><td>Median</td><td>" + stats.median + "</td></tr>";
                        table += "<tr><td>Q3</td><td>" + stats.q3 + "</td></tr>";
                        table += "<tr><td>Q3+1.5*IQR</td><td>" + stats.max + "</td></tr>";
                        table += "<tr><td>Actual Max</td><td>" + stats.actualMax + "</td></tr>";
                        table += "<tr><td>Mean</td><td>" + stats.mean + "</td></tr>";
                        table += "<tr><td>Standard Deviation</td><td>" + stats.std + "</td></tr>";
                        table += "</tbody></table>";
                        $("#hits").html(table);
                        $("#hitsModal").modal('show');
                    });

                // Median, min, and max lines
                [stats.min, stats.median, stats.max].forEach(d => {
                    group.append("line")
                        .attr("x1", center - 30)
                        .attr("x2", center + 30)
                        .attr("y1", y(d))
                        .attr("y2", y(d))
                        .attr("stroke", "black");
                });
                // draw outliers
                var outliers = data.filter(d => d[1] < stats.min || d[1] > stats.max);
                group.selectAll("circle")
                    .data(outliers)
                    .enter()
                    .append("circle")
                    .attr("cx", center)
                    .attr("cy", d => y(d[1]))
                    .attr("r", 3)
                    .attr("fill", "black")
                    // on mouseover show the genome name (d[0]) and the number of hits (d[1])
                    .on("mouseover", function (event, d) {
                        svg.append("text")
                            .attr("x", xPosition + center)
                            .attr("y", y(d[1]) - 10)
                            .attr("text-anchor", "middle")
                            .text(d[0] + ": " + d[1])
                            .attr("font-size", 12)
                            .attr("id", "tooltip");
                    })
                    .on("mouseout", function (event, d) {
                        d3.select("#tooltip").remove();
                    });
            }

            // Draw boxplots
            drawBoxPlot(statsHits, x('Below Threshold'), "#69b3a2", genome_hits.map(g => [g.genome, g.hits]));
            drawBoxPlot(statsAboveThreshold, x('Above Threshold'), "#4c8bf5", genome_hits.map(g => [g.genome, g.above_inclusion_threshold]));

            // Add X axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Threshold Category")
                .attr("font-size", 18);

            // Add Y axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .text("Number of Hits")
                .attr("font-size", 18);

            // Add title
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .text("Genome Distribution Boxplots");
        }
    </script>

</body>

</html>